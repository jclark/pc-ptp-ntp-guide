# LinuxPTP as a grandmaster

LinuxPTP includes several programs that we need to use:
* ptp4l is the main PTP daemon, which handles synchronizing the PHCs over the network
* pmc is a PTP management client, which is used to configure ptp4l, when it is being used as a grandmaster
* ts2phc handles synchronizing a PHC from timestamps generated by the NIC from a PPS input signal; it can get the time-of-day either from NMEA messages or from the system clock
* phc2sys handles synchronizing the system clock from a PHC; it can also output PHC timestamps that can be used as input by an NTP server

Start by installing the Linux PTP package.
It is called `linuxptp` on both Fedora and Debian and can be installed
in the usual way with dnf or apt.

There are a number of different approaches to setting this up.
The first section describes in detail a base configuration.
This is the simplest approach that I have works reliably
on a variety of distributions at the time of writing (2023-09).
Subsequent sections describe alternative approaches as deltas this base approach.

## Base configuration

In this setup, we get the approximate time from NTP and make that precise using the PPS input on the NIC.
This is using tsphc with its "generic" time-of-day source.

### chrony service

We assume that chrony in installed with a configuration similar to its default (without any refclocks and with several NTP servers configured using `pool` or `server` directives).

Add this [refclock](files/refclock-shm.conf) to the chrony configuration:

* In Fedora, I suggest adding `confdir /etc/chrony.d/` to `/etc/chrony.conf` and then copying the refclock .conf file into `/etc/chrony.d`. 
* In Debian, you can just copy the refclock .conf file into `/etc/chrony/conf.d`.

Then restart the chrony service. In Fedora

```
sudo systemctl restart chronyd
```

In Debian

```
sudo systemctl restart chrony
```

### ts2phc service

Install the service file [ts2phc.service](files/ts2phc.service) into the `/etc/systemd/system/` directory.

Now install the ts2phc configuration file [ts2phc.conf](files/ts2phc.conf). This goes into `/etc/` on Fedora
and into `/etc/linuxptp/` on Debian.

You may need to edit this using values you found in [Verify PPS section](service-linux.md#verify-pps):
* in `[enp1s0]` change `enp1s0` to the right interface name
* change ts2phc.pulsewidth, if your pulse width isn't 100000000 nanoseconds (i.e. 0.1s)

On Fedora, create `/etc/sysconfig/ts2phc` containining:

```
OPTIONS="-f /etc/ts2phc.conf"
```

Similarly, on Debian, create `/etc/default/tsphc` containing:

```
OPTIONS="-f /etc/linuxptp/ts2phc.conf"
```

Now start and enable the service

```
sudo systemctl enable --now ts2phc
```

You can look at the last 30 seconds of log messages from ts2phc using:

```
sudo journalctl -u ts2phc -S -30s
```

This should with a few minutes show offsets reduing to tens of nanoseconds.

Also

```
sudo phc_ctl enp1s0 cmp
```

should show a value close to 37s (i.e. close to 37000000000 nanoseconds)


### ptp4l service

### ptp4l-gm service

This service is used to configure ptp4l with settings needs to be make it work properly as a grandmaster.

Copy the service file [ts2phc.service](files/ptp4l-gm.service) into the `/etc/systemd/system/` directory.

Then enable and start it.

```
sudo systemctl enable --now ptp4l-gm.service
```

Check that it's started OK:

```
sudo systemctl status ptp4l-gm.service
```

### phc2sys service

This service feeds PPS samples from the PHC into a shared memory segment where chrony can read them.

The Debian phc2sys service file isn't suitable, so on Debian copy the
[ptp4sys.service](files/phc2sys.service) file into the `/etc/systemd/system` directory.

Now copy the [file specifying the phc2sys options](files/phc2sys.sysconfig) into `/etc/sysconfig/phc2sys`
on Fedora and `/etc/default/phc2sys` on Debian.

Then enable and start the service.

```
sudo systemctl enable --now phc2sys.service
```

Now check chrony with

```
chronyc sources
```

If everything's working, in a few seconds chrony should start using the PPS source.

### Firewall

Fedora has a firewall active by default. We will need to allow PTP through the firewall:

```
sudo firewall-cmd --add-service ptp
sudo firewall-cmd --add-service ptp --permanent
```

## Use SOCK refclock with phc2sys

In linuxptp 4.0, phc2sys can use the chrony SOCK refclock instead of SHM.

TODO: explain details

## Use nmea time-of-day source in ts2phc

I have found that unfortunately the ts2phc feature of getting time-of-day from NMEA messages does not work reliably when used with a NIC, such as the i210, that timestamps both pulse edges, in either version 3 or 4.0.

If this is fixed, then to make use of it:

* edit ts2phc.service to
  * use `-s nmea` instead of `-s generic`
  * comment out the `After=time-sync.target` line
* edit the `refclock` line in the chrony conf to remove the `pps` option

A further variation here is not to use chrony.

TODO: are there are dependencies that need fixing?

## Time of day from gpsd via chrony

The idea in this approach is that chrony gets the time-of-day from gpsd.

TODO: explain details

## Allow chrony server to use hardware timestamping

Chrony can transfer time over NTP more accurately when it is using hardware timestamping.
Hardware timestamping in chrony requires the PHC to be free-running, which means
it is not kept in sync with the actual time, whereas PTP requires it to be in sync.

To make them work together on the same PHC, we have to use the vclock feature.
A vclock is a virtual PTP hardware clock, which is additional PTP hardware clock device /dev/ptpN
on top of a physical PTP hardware clock.
PTP will use the vclock, and chrony will use the underlying clock.

To create one vclock on top of /dev/ptp0, we write 1 to `/sys/class/ptp/ptp0/n_vclocks`.
If the newly created PHC is /dev/ptp4, then there will be a directory `/sys/class/ptp/ptp0/ptp4`.
We would then need to use /dev/ptp4 in ts2phc.conf instead of enp1s0, and specify `phc_index 4`
in ptp4l.conf.

TODO: Figure out how get this to be setup automatically with systemd.
Need to wait till the underlying network interface/ptp character device appears,
perhaps by using `After=sys-subsystem-net-devices-enp1s0.device`.
This could then produce edited ts2phc.conf and ptp4l.conf in /var/run
for use by ptp4l and ts2phc services.


