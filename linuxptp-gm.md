# LinuxPTP as a grandmaster

LinuxPTP includes several programs that we need to use:
* ptp4l is the main PTP daemon, which handles synchronizing the PHCs over the network
* pmc is a PTP management client, which is used to configure ptp4l, when it is being used as a grandmaster
* ts2phc handles synchronizing a PHC from timestamps generated by the NIC from a PPS input signal; it can get the time-of-day either from NMEA messages or from the system clock
* phc2sys handles synchronizing the system clock from a PHC; it can also output PHC timestamps that can be used as input by an NTP server

I have found that unfortunately the ts2phc feature of getting time-of-day from NMEA messages does not work reliably when used with a NIC, such as the i210, that timestamps both pulse edges.

## Time of day from chrony

In this setup, we get the approximate time from NTP and make that precise using the PPS input on the NIC.
This is using tsphc with its "generic" time-of-day source.

### chrony service

We assume that chrony in installed with a configuration similar to its default (without any refclocks and with several NTP servers configured using `pool` or `server` directives).

Add this [refclock](files/refclock-shm.conf) to the chrony configuration:

* In Fedora, I suggest adding `confdir /etc/chrony.d/` to `/etc/chrony.conf` and then copying the refclock .conf file into `/etc/chrony.d`. 
* In Debian, you can just copy the refclock .conf file into `/etc/chrony/conf.d`.

Then restart the chrony service. In Fedora

```
sudo systemctl restart chronyd
```

In Debian

```
sudo systemctl restart chrony
```

### ts2phc service

Install the service file [ts2phc.service](files/ts2phc.service) into the `/etc/systemd/system/` directory.

Now install the ts2phc configuration file [ts2phc.conf](files/ts2phc.conf). This goes into `/etc/` on Fedora
and into `/etc/linuxptp/` on Debian.

On Fedora, create `/etc/sysconfig/ts2phc` containining:

```
OPTIONS="-f /etc/ts2phc.conf"
```

Similarly, on Debian, create `/etc/default/tsphc` containing:

```
OPTIONS="-f /etc/linuxptp/ts2phc.conf"
```

Now start and enable the service

```
sudo systemctl enable --now ts2phc
```

You can look at the last 30 seconds of log messages from ts2phc using:

```
sudo journalctl -u ts2phc -S -30s
```

This should with a few minutes show offsets reduing to tens of nanoseconds.


### ptp4l service

### ptp4l-gm service

This service is used to configure ptp4l with settings needs to be make it work properly as a grandmaster.

### phc2sys service

This service feeds PPS samples from the PHC into a shared memory segment where chrony can read them.

## Time of day from gpsd

Possible approach (not yet worked through) different from above makes gpsd feeds time of day from GPS messages into an SHM segment where it is used by chrony

